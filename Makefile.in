# Warning: this file must be usable by regular make
# (unlike the Makefiles in subdirectories).

SHELL = @SHELL@
@SUBMAKE@

PACKAGE = click
VERSION = @CLICK_VERSION@

top_srcdir = @top_srcdir@
srcdir = @srcdir@
top_builddir = .
subdir = .
conf_auxdir = @conf_auxdir@

AUTOCONF = @AUTOCONF@
ACLOCAL = cp acclick.m4 aclocal.m4
PERL = @PERL@
INSTALL = @INSTALL@
INSTALL_IF_CHANGED = @INSTALL_IF_CHANGED@
INSTALL_DATA = @INSTALL@ -m 644
INSTALL_DATA_IF_CHANGED = @INSTALL_IF_CHANGED@ -m 644
mkinstalldirs = $(conf_auxdir)/mkinstalldirs

EXTRA_PROVIDES =
PROVISIONS = @provisions@ $(EXTRA_PROVIDES)

prefix = @prefix@
exec_prefix = @exec_prefix@
includedir = @includedir@/click
netincludedir = @includedir@/clicknet
toolincludedir = @includedir@/clicktool
bindir = @bindir@
datadir = @datadir@/click

all: @TARGETS@ tools Makefile

bsdmodule: Makefile stamp-h
	@cd bsdmodule && $(MAKE) all
linuxmodule: Makefile stamp-h
	@cd linuxmodule && $(MAKE) all
ns: Makefile stamp-h
	@cd ns && $(MAKE) all
userlevel: Makefile click-compile stamp-h
	@cd userlevel && $(MAKE) all
exopc: Makefile stamp-h
	@cd exopc && $(MAKE) all
tools: Makefile
	@cd tools && $(MAKE) all

install: click-compile stamp-h
	@for d in @TARGETS@ tools; do (cd $$d && $(MAKE) install) || exit 1; done
	@$(MAKE) install-local install-doc install-local-include
install-local: elementmap $(srcdir)/click-buildtool click-compile
	$(mkinstalldirs) $(bindir)
	$(INSTALL_IF_CHANGED) $(srcdir)/click-buildtool $(bindir)/click-buildtool
	$(INSTALL_IF_CHANGED) click-compile $(bindir)/click-compile
	$(INSTALL_IF_CHANGED) $(srcdir)/click-mkelemmap $(bindir)/click-mkelemmap
	$(mkinstalldirs) $(datadir)
	$(INSTALL_DATA) elementmap $(datadir)/elementmap
	(cd $(top_srcdir); pwd) > $(datadir)/srcdir
	/bin/rm -rf $(datadir)/src
	/bin/ln -s `cd $(top_srcdir); pwd` $(datadir)/src
install-doc:
	@cd doc && $(MAKE) install
install-info:
	@cd doc && $(MAKE) install-info
install-man:
	@-for d in @TARGETS@ tools doc; do (cd $$d && $(MAKE) install-man); done
install-local-include: stamp-h
	$(mkinstalldirs) $(includedir)
	$(INSTALL_DATA_IF_CHANGED) $(srcdir)/include/click/*.h $(includedir)
	$(INSTALL_DATA_IF_CHANGED) $(srcdir)/include/click/*.hh $(includedir)
	$(INSTALL_DATA_IF_CHANGED) $(srcdir)/include/click/*.cc $(includedir)
	$(INSTALL_DATA_IF_CHANGED) $(top_builddir)/include/click/*.h $(includedir)
	$(mkinstalldirs) $(includedir)/standard
	$(INSTALL_DATA_IF_CHANGED) $(srcdir)/include/click/standard/*.hh $(includedir)/standard
	$(mkinstalldirs) $(netincludedir)
	$(INSTALL_DATA_IF_CHANGED) $(srcdir)/include/clicknet/*.h $(netincludedir)
install-include: install-local-include
	@cd tools && $(MAKE) install-include

elemlist elemlists:
	@for d in @TARGETS@; do (cd $$d && $(MAKE) elemlist) || exit 1; done

elementmap: $(srcdir)/click-buildtool $(srcdir)/click-mkelemmap always
	t="@element_groups@ @TARGETS@ $(EXTRA_PROVIDES)"; echo $$t | (cd $(top_srcdir); ./click-buildtool findelem -r "$(PROVISIONS) @TARGETS@" | $(PERL) ./click-mkelemmap -r "$(PROVISIONS) $$t" -Iinclude) > elementmap
always:
	@:

click-compile: $(srcdir)/click-compile.in
	cd $(top_builddir) && \
	  CONFIG_FILES=$(subdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status
	@chmod +x click-compile; touch click-compile

$(srcdir)/configure: $(srcdir)/configure.in $(srcdir)/acclick.m4
	cd $(srcdir) && $(ACLOCAL) && $(AUTOCONF)
config.status: $(srcdir)/configure
	$(SHELL) $(srcdir)/configure @ac_configure_args@
Makefile: config.status $(srcdir)/Makefile.in
	cd $(top_builddir) && \
	  CONFIG_FILES=$@ CONFIG_HEADERS= $(SHELL) ./config.status
config.h: stamp-h
stamp-h: $(srcdir)/config.h.in $(srcdir)/config-bsdmodule.h.in $(srcdir)/config-linuxmodule.h.in $(srcdir)/config-ns.h.in $(srcdir)/config-userlevel.h.in config.status
	cd $(top_builddir) \
	  && CONFIG_FILES= $(SHELL) ./config.status
	echo > stamp-h

check-filenames:
	@a=`find . \( -name \*.cc -or -name \*.c \) -print | sed 's/.*\/\(.*\)\.c*$$/\1.o/' | grep -v 'elements\.o' | sort | uniq -d`; \
	if test -z $$a; then echo OK; else echo "*** warning: duplicate object file names:"; echo "$$a"; fi

clean:
	@-for d in @POSSIBLE_TARGETS@ tools doc; do (cd $$d && $(MAKE) clean); done
	-rm -f elementmap conftest.*
distclean:
	@-for d in @POSSIBLE_TARGETS@ tools doc; do (cd $$d && $(MAKE) distclean); done
	-rm -f Makefile config.status etc/libclick/Makefile
	-rm -f include/click/config.h include/click/config-*.h include/click/pathvars.h
	-rm -f config.cache config.log click-compile stamp-h
	-rm -f elementmap conftest.*


distdir = $(PACKAGE)-$(VERSION)
top_distdir = $(distdir)

dist: distdir
distdir: $(srcdir)/configure
	cd doc && $(MAKE) info
	cp $(srcdir)/acclick.m4 $(srcdir)/aclocal.m4 $(srcdir)/etc/samplepackage; cd $(srcdir)/etc/samplepackage; $(AUTOCONF)
	-rm -rf $(distdir)
	mkdir $(distdir)
	@-chmod 777 $(distdir)
	@echo Copying library, documentation, configuration, and driver files...
	@for file in `cat $(srcdir)/DISTFILES`; do \
	  d=$(srcdir); \
	  if test -d "$$d/$$file"; then \
	    mkdir $(distdir)/$$file; \
	    chmod 777 $(distdir)/$$file; \
	  else \
	    for f in `cd $$d && echo $$file`; do \
	      test -f "$(distdir)/$$f" \
	      || ln $$d/$$f $(distdir)/$$f 2> /dev/null \
	      || cp -p $$d/$$f $(distdir)/$$f \
	      || echo "Could not copy $$d/$$f!" 1>&2; \
	  done; fi; \
	done
	@echo Copying element files...
	@mkdir $(distdir)/elements
	@-chmod 777 $(distdir)/elements
	@d=$(srcdir); \
	for dir in `cd $$d && find elements -type d | grep -v 'exopc\|CVS'`; do \
	  mkdir $(distdir)/$$dir 2>/dev/null; \
	  chmod 777 $(distdir)/$$dir; \
	  for cfile in `cd $$d && find $$dir -maxdepth 1 \( -name \[^,.]\*.cc -or -name \[^,.]\*.c -or -name \[^,.]\*.hh -or -name \[^,.]\*.h -or -name README \) -print`; do \
	    ln $$d/$$cfile $(distdir)/$$cfile; \
	  done; \
	done
	@echo Removing files not meant for distribution...
	@if test -r $(srcdir)/NODIST; then \
	for i in `cat $(srcdir)/NODIST`; do \
	  rm -rf $(distdir)/$$i; \
	done; fi
	@if grep -q 'Id:.*benjie' `find $(srcdir)/etc -maxdepth 1 -type f`; then \
	  echo 'ERROR: Benjie must be punished!'; exit 1; \
	fi
	@if test `grep 'CLICK_VERSION=' $(srcdir)/configure.in` != `grep 'CLICK_VERSION=' $(srcdir)/etc/libclick/lc-configure.in`; then \
	  echo 'ERROR: Bad libclick CLICK_VERSION!'; exit 1; \
	fi


.PHONY: all always elemlist elemlists \
	bsdmodule exopc linuxmodule ns tools userlevel \
	clean distclean dist distdir \
	install install-doc install-man install-local install-include install-local-include
