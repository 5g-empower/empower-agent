#!/bin/sh

prefix=@prefix@
exec_prefix=@exec_prefix@
includedir=@includedir@/click
srcdir=@datadir@/click/src
linuxdir=@linuxdir@

# determine mode
target=
package=NONE
cflags=
compileflag=-c
while true; do
  bad=x
  case $1 in
    -t|--t|--ta|--tar|--targ|--targe|--target)
      target=$2; shift 2;;
    --t=*|--ta=*|--tar=*|--targ=*|--targe=*|--target=*)
      target=`echo "$1" | sed 's/[-a-z]*=//'`; shift 1;;
    -p|--p|--pa|--pac|--pack|--packa|--packag|--package)
      package=$2; shift 2;;
    --p=*|--pa=*|--pac=*|--pack=*|--packa=*|--packag=*|--package=*)
      package=`echo "$1" | sed 's/[-a-z]*=//'`; shift 1;;
    -h|--h|--he|--hel|--help)
      cat <<'EOF' 1>&2
`Click-compile' compiles a Click source file.

Usage: click-compile -t TARGET [OPTIONS] SOURCEFILE...

Options:
  -t, --target TARGET     Sets target to `kernel', `user', or `tool'.
  -p, --package PACKAGE   Build a dynamically loadable package named PACKAGE.
  -h, --help              Print this message and exit.
  Other options are passed to the compiler unchanged.

Report bugs to <click@pdos.lcs.mit.edu>.
EOF
      exit 0;;
    -*)
      if test $1 = -E -o $1 = -c -o $1 = -S; then
        compileflag=$1
      else cflags="$cflags '$1'"; fi
      shift 1;;
    *)
      bad=;;
  esac
  if test -z "$bad"; then break; fi
done

case $target in
  k|ke|ker|kern|kerne|kernel|m|mo|mod|modu|modul|module)
    idefs="@DEFS@ -DCLICK_LINUXMODULE"
    iincludes="-I${srcdir} -I${srcdir}/lib -I${linuxdir}/include"
    icxxflags="@CXXFLAGS_NDEBUG@"
    command="${CXX-@KERNEL_CXX@} ${DEFS-$idefs} ${INCLUDES-$iincludes} ${CPPFLAGS-} ${CXXFLAGS-$icxxflags} $cflags $compileflag"
    target=module;;
  u|us|use|user)
    idefs="@DEFS@ -DCLICK_USERLEVEL"
    iincludes="-I${srcdir} -I${srcdir}/lib"
    icxxflags="@CXXFLAGS@"
    command="${CXX-@CXX@} ${DEFS-$idefs} ${INCLUDES-$iincludes} ${CPPFLAGS-} ${CXXFLAGS-$icxxflags} $cflags $compileflag"
    target=user;;
  t|to|too|tool)
    idefs="@DEFS@ -DCLICK_TOOL"
    iincludes="-I${srcdir} -I${srcdir}/lib"
    icxxflags="@CXXFLAGS@"
    command="${CXX-@CXX@} ${DEFS-$idefs} ${INCLUDES-$iincludes} ${CPPFLAGS-} ${CXXFLAGS-$icxxflags} $cflags $compileflag"
    target=tool;;
  "")
    echo "click-compile: you must specify a target" 1>&2; exit 1;;
  *)
    echo "click-compile: acceptable targets are \`kernel', \`user', and \`tool'" 1>&2; exit 1;;
esac

# do stuff
if test "x$package" != "xNONE"; then
  for file; do
    echo $command $file 1>&2
    eval $command $file || exit 1
    files="$files "`echo $file | sed 's/\.c*$/\.o/;s/^.*\///'`
  done
  if test $target = module; then
    vfile=kernelversion
    trap 'rm -f $vfile.c $vfile.o; exit 1' 1 2 15
    cat > $vfile.c << EOF
#define __KERNEL__
#define MODULE
#include <linux/module.h>
/* a new version of EXPORT_NO_SYMBOLS that works */
const int __ksymtab_nothing[0] __attribute__((section("__ksymtab"))) = { };
EOF
    command="${CC-@CC@ -w} -I${linuxdir}/include -c $vfile.c"
    echo $command 1>&2
    eval $command || (rm -f $vfile.*; exit 1)
    command="ld -r -o $package $files $vfile.o"
    echo $command 1>&2
    eval $command || (rm -f $vfile.*; exit 1)
    rm -f $vfile.*
    exit 0 
  elif test $target = user; then
    command="ld -shared -o $package $files"
    echo $command 1>&2
    eval $command
    exit 0
  fi
else
  echo $command "$@" 1>&2
  eval $command "$@"
fi
